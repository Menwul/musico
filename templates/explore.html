<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Music - SoundConnect</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="logo">
            <i class="fas fa-music"></i>
            <span>SoundConnect</span>
        </a>
        
        <div class="nav-links">
            <a href="/"><i class="fas fa-home"></i> Home</a>
            <a href="/explore" class="active"><i class="fas fa-compass"></i> Explore</a>
            <a href="/follow"><i class="fas fa-user-plus"></i> Connect</a>
        <a href="/upload"><i class="fas fa-upload"></i> Upload</a>
            <a href="/chat"><i class="fas fa-comments"></i> Chat</a>
            <a href="/dashboard"><i class="fas fa-chart-line"></i> Dashboard</a>
        </div>
        
        <div class="auth-buttons">
            <!-- Will be populated by app.js -->
        </div>
    </nav>

    <div class="container">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1>Discover Amazing Music</h1>
            <p style="color: var(--gray); max-width: 600px; margin: 1rem auto;">
                Explore tracks from talented artists around the world
            </p>
            
            <!-- Search -->
            <div style="max-width: 500px; margin: 2rem auto;">
                <div style="position: relative;">
                    <input type="text" id="searchInput" class="form-control" 
                           placeholder="Search tracks, artists, or genres..."
                           onkeypress="handleSearchKeyPress(event)">
                    <button onclick="searchTracks()" class="btn btn-primary" 
                            style="position: absolute; right: 5px; top: 5px; bottom: 5px;">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Filters -->
            <div id="genreFilters" style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                <button class="btn btn-outline btn-small active" onclick="filterByGenre('all')">
                    All Genres
                </button>
                <button class="btn btn-outline btn-small" onclick="filterByGenre('Hip Hop')">
                    Hip Hop
                </button>
                <button class="btn btn-outline btn-small" onclick="filterByGenre('Rock')">
                    Rock
                </button>
                <button class="btn btn-outline btn-small" onclick="filterByGenre('Electronic')">
                    Electronic
                </button>
                <button class="btn btn-outline btn-small" onclick="filterByGenre('Pop')">
                    Pop
                </button>
                <button class="btn btn-outline btn-small" onclick="filterByGenre('R&B')">
                    R&B
                </button>
            </div>
        </div>
        
        <!-- Search Results Info -->
        <div id="searchInfo" style="text-align: center; margin-bottom: 2rem; display: none;">
            <h3>Search Results</h3>
            <p id="searchQueryInfo" style="color: var(--gray);"></p>
            <button class="btn btn-outline btn-small" onclick="clearSearch()">
                <i class="fas fa-times"></i> Clear Search
            </button>
        </div>
        
        <!-- Tracks Grid -->
        <div id="tracksGrid" class="grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading tracks...</p>
            </div>
        </div>
        
        <!-- No Results -->
        <div id="noResults" style="text-align: center; padding: 3rem; display: none;">
            <i class="fas fa-search" style="font-size: 3rem; color: var(--gray);"></i>
            <h3 style="margin-top: 1rem;">No tracks found</h3>
            <p style="color: var(--gray); margin-top: 0.5rem;">Try a different search term or browse all tracks</p>
            <button class="btn btn-primary" onclick="clearSearch()" style="margin-top: 1rem;">
                <i class="fas fa-music"></i> Browse All Tracks
            </button>
        </div>
        
        <!-- Load More -->
        <div style="text-align: center; margin-top: 3rem;">
            <button id="loadMoreBtn" class="btn btn-primary" onclick="loadMoreTracks()" style="display: none;">
                <i class="fas fa-sync-alt"></i> Load More Tracks
            </button>
        </div>
    </div>

    <!-- Audio Player -->
    <div id="playerContainer" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--dark); border-top: 1px solid var(--border-color); padding: 1rem; z-index: 1000;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                <img id="playerCover" src="" alt="" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                <div>
                    <div id="playerTitle" style="font-weight: bold; color: white;"></div>
                    <div id="playerArtist" style="font-size: 0.9rem; color: var(--text-light);"></div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="skipBack()" class="btn btn-outline btn-small">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button onclick="togglePlay()" class="btn btn-primary">
                    <i id="playIcon" class="fas fa-play"></i>
                </button>
                <button onclick="skipForward()" class="btn btn-outline btn-small">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>
            
            <div style="flex: 2; display: flex; align-items: center; gap: 1rem;">
                <span id="currentTime">0:00</span>
                <div onclick="seekTrack(event)" style="flex: 1; height: 4px; background: var(--gray-dark); border-radius: 2px; cursor: pointer;">
                    <div id="progressFill" style="height: 100%; background: var(--primary); width: 0%;"></div>
                </div>
                <span id="duration">0:00</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                <i class="fas fa-volume-up" style="color: var(--text-light);"></i>
                <input type="range" id="volumeSlider" min="0" max="100" value="80" 
                       oninput="updateVolume(this.value)" style="width: 100px;">
            </div>
            
            <button onclick="closePlayer()" class="btn btn-outline btn-small">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // Check authentication first
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }
        
        // Global variables
        let currentPage = 1;
        let currentGenre = 'all';
        let currentSearch = '';
        let isLoading = false;
        let hasMoreTracks = true;
        let allTracks = [];
        let currentTrackIndex = -1;
        let audioPlayer = new Audio();
        let isPlaying = false;
        let isSearching = false;
        
        // DOM Elements
        const tracksGrid = document.getElementById('tracksGrid');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const searchInfo = document.getElementById('searchInfo');
        const searchQueryInfo = document.getElementById('searchQueryInfo');
        const noResults = document.getElementById('noResults');
        const playerContainer = document.getElementById('playerContainer');
        const playerCover = document.getElementById('playerCover');
        const playerTitle = document.getElementById('playerTitle');
        const playerArtist = document.getElementById('playerArtist');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const progressFill = document.getElementById('progressFill');
        const volumeSlider = document.getElementById('volumeSlider');
        const playIcon = document.getElementById('playIcon');
        const searchInput = document.getElementById('searchInput');
        
        // API Base URL
        const API_BASE = window.location.origin;
        
        // Utility functions
        function showNotification(message, type = 'info') {
            alert(`${type}: ${message}`);
        }
        
        function requireAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Please log in to perform this action', 'warning');
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        // Initialize audio player
        function initAudioPlayer() {
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(audioPlayer.duration);
            });
            audioPlayer.addEventListener('ended', nextTrack);
            audioPlayer.volume = volumeSlider.value / 100;
        }
        
        // Update progress bar
        function updateProgress() {
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;
            
            if (duration) {
                const progress = (currentTime / duration) * 100;
                progressFill.style.width = `${progress}%`;
                currentTimeEl.textContent = formatTime(currentTime);
            }
        }
        
        // Toggle play/pause
        function togglePlay() {
            if (isPlaying) {
                audioPlayer.pause();
                playIcon.className = 'fas fa-play';
            } else {
                audioPlayer.play();
                playIcon.className = 'fas fa-pause';
            }
            isPlaying = !isPlaying;
        }
        
        // Play specific track
        async function playTrack(track, index) {
            if (!track.file_url) {
                showNotification('No audio file available for this track', 'error');
                return;
            }
            
            // Update player UI
            playerCover.src = track.cover_art || 'https://via.placeholder.com/300x200/8a2be2/ffffff?text=No+Cover';
            playerTitle.textContent = track.title;
            playerArtist.textContent = track.artist?.display_name || track.artist?.username || 'Unknown Artist';
            
            // Set audio source
            const audioUrl = track.file_url.startsWith('http') ? track.file_url : `${API_BASE}${track.file_url}`;
            audioPlayer.src = audioUrl;
            currentTrackIndex = index;
            
            // Show player
            playerContainer.style.display = 'block';
            
            // Play
            audioPlayer.play();
            isPlaying = true;
            playIcon.className = 'fas fa-pause';
            
            // Increment play count
            await incrementPlayCount(track.id);
        }
        
        // Skip to next track
        function nextTrack() {
            if (allTracks.length > 0 && currentTrackIndex < allTracks.length - 1) {
                playTrack(allTracks[currentTrackIndex + 1], currentTrackIndex + 1);
            }
        }
        
        // Skip to previous track
        function previousTrack() {
            if (allTracks.length > 0 && currentTrackIndex > 0) {
                playTrack(allTracks[currentTrackIndex - 1], currentTrackIndex - 1);
            }
        }
        
        // Seek in track
        function seekTrack(event) {
            const progressBar = event.currentTarget;
            const clickX = event.offsetX;
            const width = progressBar.offsetWidth;
            const percentage = clickX / width;
            
            if (audioPlayer.duration) {
                audioPlayer.currentTime = percentage * audioPlayer.duration;
            }
        }
        
        // Update volume
        function updateVolume(value) {
            audioPlayer.volume = value / 100;
        }
        
        // Close player
        function closePlayer() {
            audioPlayer.pause();
            isPlaying = false;
            playerContainer.style.display = 'none';
        }
        
        // Increment play count
        async function incrementPlayCount(trackId) {
            try {
                const response = await fetch(`${API_BASE}/api/tracks/${trackId}/play`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    console.error('Failed to increment plays');
                }
            } catch (error) {
                console.error('Failed to increment plays:', error);
            }
        }
        
        // Search tracks from backend
        function searchTracks() {
            const query = searchInput.value.trim();
            if (!query) {
                showNotification('Please enter a search term', 'warning');
                return;
            }
            
            currentSearch = query;
            currentPage = 1;
            currentGenre = 'all';
            isSearching = true;
            
            // Show search info
            searchInfo.style.display = 'block';
            searchQueryInfo.textContent = `Search results for: "${query}"`;
            
            // Reset active genre button
            document.querySelectorAll('#genreFilters .btn-outline').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#genreFilters .btn-outline:first-child').classList.add('active');
            
            // Perform search
            loadSearchResults(query, 1);
        }
        
        // Load search results from backend
        async function loadSearchResults(query, page = 1) {
            if (isLoading) return;
            
            isLoading = true;
            
            if (page === 1) {
                tracksGrid.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Searching for "${query}"...</p>
                    </div>
                `;
                noResults.style.display = 'none';
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}&page=${page}&limit=12`);
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }
                
                const result = await response.json();
                const tracks = result.tracks || [];
                
                if (tracks.length > 0) {
                    if (page === 1) {
                        tracksGrid.innerHTML = '';
                        allTracks = tracks;
                    } else {
                        allTracks = [...allTracks, ...tracks];
                    }
                    
                    renderTracks(tracks, page === 1);
                    
                    // Update load more button
                    hasMoreTracks = tracks.length === 12 && result.total > page * 12;
                    loadMoreBtn.style.display = hasMoreTracks ? 'inline-block' : 'none';
                    noResults.style.display = 'none';
                } else {
                    if (page === 1) {
                        tracksGrid.innerHTML = '';
                        noResults.style.display = 'block';
                        loadMoreBtn.style.display = 'none';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                tracksGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning);"></i>
                        <p>Search failed</p>
                        <button class="btn btn-primary" onclick="searchTracks()" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
                noResults.style.display = 'none';
            } finally {
                isLoading = false;
            }
        }
        
        // Load tracks from backend (for regular browsing)
        async function loadTracks(page = 1, genre = 'all') {
            if (isLoading) return;
            
            isLoading = true;
            
            if (page === 1) {
                tracksGrid.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading tracks...</p>
                    </div>
                `;
                noResults.style.display = 'none';
                searchInfo.style.display = 'none';
            }
            
            try {
                let url = `${API_BASE}/api/tracks?page=${page}&limit=12`;
                if (genre !== 'all') {
                    url += `&genre=${encodeURIComponent(genre)}`;
                }
                
                console.log('Fetching tracks from:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch tracks: ${response.status}`);
                }
                
                const result = await response.json();
                const tracks = result.tracks || [];
                
                console.log('Received tracks:', tracks.length);
                
                if (tracks.length > 0) {
                    if (page === 1) {
                        tracksGrid.innerHTML = '';
                        allTracks = tracks;
                    } else {
                        allTracks = [...allTracks, ...tracks];
                    }
                    
                    renderTracks(tracks, page === 1);
                    
                    // Update load more button
                    hasMoreTracks = tracks.length === 12 && result.total > page * 12;
                    loadMoreBtn.style.display = hasMoreTracks ? 'inline-block' : 'none';
                    noResults.style.display = 'none';
                } else {
                    if (page === 1) {
                        tracksGrid.innerHTML = '';
                        noResults.style.display = 'block';
                        loadMoreBtn.style.display = 'none';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading tracks:', error);
                tracksGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning);"></i>
                        <p>Failed to load tracks</p>
                        <p style="color: var(--gray); font-size: 0.9rem;">${error.message}</p>
                        <button class="btn btn-primary" onclick="loadTracks(1, currentGenre)" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
                noResults.style.display = 'none';
            } finally {
                isLoading = false;
            }
        }
        
        // Render tracks to grid
        function renderTracks(tracks, clear = false) {
            if (clear) {
                tracksGrid.innerHTML = '';
            }
            
            tracks.forEach((track, index) => {
                const trackCard = document.createElement('div');
                trackCard.className = 'track-card';
                
                // Escape track data for HTML
                const escapedTrack = {
                    ...track,
                    cover_art: track.cover_art || 'https://via.placeholder.com/300x200/8a2be2/ffffff?text=No+Cover',
                    title: track.title || 'Untitled',
                    artist: track.artist || { display_name: 'Unknown Artist', username: 'unknown' }
                };
                
                trackCard.innerHTML = `
                    <div style="position: relative;">
                        <img src="${escapedTrack.cover_art}" 
                             alt="${escapedTrack.title}" 
                             class="track-cover"
                             style="cursor: pointer;"
                             onclick="playTrack(${JSON.stringify(escapedTrack).replace(/"/g, '&quot;')}, ${(currentPage - 1) * 12 + index})">
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;"
                             onclick="playTrack(${JSON.stringify(escapedTrack).replace(/"/g, '&quot;')}, ${(currentPage - 1) * 12 + index})">
                            <i class="fas fa-play" style="color: white;"></i>
                        </div>
                    </div>
                    <div class="track-info">
                        <div class="track-title">${escapedTrack.title}</div>
                        <div class="track-artist">${escapedTrack.artist.display_name || escapedTrack.artist.username || 'Unknown Artist'}</div>
                        <div class="track-stats">
                            <span><i class="fas fa-play"></i> ${escapedTrack.plays || 0}</span>
                            <span><i class="fas fa-heart"></i> ${escapedTrack.likes_count || 0}</span>
                            <span><i class="fas fa-comment"></i> ${escapedTrack.comments_count || 0}</span>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline btn-small like-btn" 
                                    data-track-id="${escapedTrack.id}"
                                    onclick="likeTrack('${escapedTrack.id}', this)">
                                <i class="fas fa-heart"></i> Like
                            </button>
                            <button class="btn btn-outline btn-small" 
                                    onclick="viewTrack('${escapedTrack.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                `;
                tracksGrid.appendChild(trackCard);
            });
        }
        
        // Check if track is liked
        function isTrackLiked(trackId) {
            // This would need to check against user's liked tracks
            // For now, return false
            return false;
        }
        
        // Load more tracks
        function loadMoreTracks() {
            if (!hasMoreTracks || isLoading) return;
            currentPage++;
            
            if (isSearching) {
                loadSearchResults(currentSearch, currentPage);
            } else {
                loadTracks(currentPage, currentGenre);
            }
        }
        
        // Filter by genre
        function filterByGenre(genre) {
            currentPage = 1;
            currentGenre = genre;
            currentSearch = '';
            isSearching = false;
            searchInput.value = '';
            
            // Update active button
            document.querySelectorAll('#genreFilters .btn-outline').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide search info
            searchInfo.style.display = 'none';
            
            loadTracks(1, genre);
        }
        
        // Handle enter key in search
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchTracks();
            }
        }
        
        // Clear search
        function clearSearch() {
            currentSearch = '';
            currentPage = 1;
            isSearching = false;
            searchInput.value = '';
            searchInfo.style.display = 'none';
            noResults.style.display = 'none';
            
            // Reset to all genres
            document.querySelectorAll('#genreFilters .btn-outline').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#genreFilters .btn-outline:first-child').classList.add('active');
            
            loadTracks(1, 'all');
        }
        
        // Like/unlike track
        async function likeTrack(trackId, button) {
            if (!requireAuth()) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/tracks/${trackId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to like track');
                }
                
                const data = await response.json();
                
                if (data.action === 'liked') {
                    button.innerHTML = '<i class="fas fa-heart" style="color: var(--danger);"></i> Liked';
                    showNotification('Track liked!', 'success');
                } else {
                    button.innerHTML = '<i class="fas fa-heart"></i> Like';
                    showNotification('Track unliked', 'info');
                }
                
                // Update like count in UI
                const trackCard = button.closest('.track-card');
                if (trackCard) {
                    const statsElement = trackCard.querySelector('.track-stats span:nth-child(2)');
                    if (statsElement) {
                        const currentLikes = parseInt(statsElement.textContent.replace(/\D/g, '')) || 0;
                        const newLikes = data.action === 'liked' ? currentLikes + 1 : Math.max(0, currentLikes - 1);
                        statsElement.innerHTML = `<i class="fas fa-heart"></i> ${newLikes}`;
                    }
                }
            } catch (error) {
                console.error('Error liking track:', error);
                showNotification('Failed to like track', 'error');
            }
        }
        
        // View track details
        function viewTrack(trackId) {
            window.location.href = `/track/${trackId}`;
        }
        
        // Skip forward/backward
        function skipBack() {
            previousTrack();
        }
        
        function skipForward() {
            nextTrack();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initAudioPlayer();
            loadTracks(1, 'all');
        });
    </script>
</body>
</html>